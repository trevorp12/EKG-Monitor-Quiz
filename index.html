<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECG Rhythm Quiz</title>
    <style>
        body {font-family: 'Segoe UI', sans-serif; background:#1e1e1e; color:#e0e0e0; margin:0; padding:20px; display:flex; flex-direction:column; align-items:center;}
        #header {width:100%; max-width:800px; margin-bottom:20px; text-align:center;}
        #category-bar {display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-bottom:15px;}
        .category-btn {background:#333; color:#fff; border:1px solid #555; padding:8px 16px; border-radius:6px; cursor:pointer; font-size:14px;}
        .category-btn:hover, .category-btn.active {background:#00bfff; color:#1a1a1a;}
        #quiz-settings {display:flex; justify-content:center; gap:15px; margin-bottom:15px; flex-wrap:wrap;}
        #quiz-settings select, #start-btn {padding:8px 12px; border-radius:6px; border:1px solid #555; background:#2c2c2c; color:#e0e0e0; font-size:14px;}
        #start-btn {background:#00ff7f; color:#1a1a1a; font-weight:bold; cursor:pointer;}
        #start-btn:hover {background:#00cc66;}
        #monitor {width:100%; max-width:800px; height:200px; background:#2c2c2c; border:2px solid #4a4a4a; overflow:hidden; margin-bottom:20px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.6);}
        canvas {display:block; width:100%; height:100%;}
        #quiz-container {max-width:600px; text-align:center; background:#2c2c2c; padding:25px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.6);}
        #question {font-size:20px; margin-bottom:15px; font-weight:bold;}
        #options {list-style:none; padding:0; margin:0;}
        #options li {margin:10px 0; padding:12px; background:#3a3a3a; border:1px solid #5a5a5a; cursor:pointer; border-radius:6px;}
        #options li:hover {background:#4a4a4a;}
        #options li.selected {background:#00ff7f; color:#1a1a1a; font-weight:bold;}
        #feedback {margin-top:20px; font-size:16px; min-height:50px; padding:10px; background:#333; border-radius:6px;}
        #score {display:none; font-size:28px; margin:20px 0; font-weight:bold;}
        button {background:#00ff7f; color:#1a1a1a; border:none; padding:10px 20px; font-size:16px; cursor:pointer; margin:10px 5px; border-radius:6px; font-weight:bold;}
        button:hover {background:#00cc66;}
        .hidden {display:none;}
    </style>
</head>
<body>

<div id="header">
    <h1>ECG Rhythm Quiz</h1>
    <div id="category-bar">
        <button class="category-btn active" data-type="all">All Rhythms</button>
        <button class="category-btn" data-type="nsr">Normal Sinus</button>
        <button class="category-btn" data-type="sinusTach">Sinus Tach</button>
        <button class="category-btn" data-type="sinusBrad">Sinus Brad</button>
        <button class="category-btn" data-type="vFib">V-Fib</button>
        <button class="category-btn" data-type="vTach">V-Tach</button>
        <button class="category-btn" data-type="asystole">Asystole</button>
    </div>
    <div id="quiz-settings">
        <select id="question-count">
            <option value="10">10 Questions</option>
            <option value="15" selected>15 Questions</option>
            <option value="20">20 Questions</option>
            <option value="25">25 Questions</option>
        </select>
        <button id="start-btn">Start Quiz</button>
    </div>
</div>

<div id="monitor">
    <canvas id="ecg-canvas"></canvas>
</div>

<div id="quiz-container" class="hidden">
    <div id="question"></div>
    <ul id="options"></ul>
    <button id="submit-btn">Submit Answer</button>
    <button id="next-btn" class="hidden">Next Question</button>
    <div id="feedback"></div>
    <div id="score"></div>
</div>

<script>
    // Canvas
    const canvas = document.getElementById('ecg-canvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    const speed = 2;
    const lineColor = '#00ff7f';
    let offset = 0;
    let currentRhythm = null;

    function resizeCanvas() {
        width = canvas.clientWidth;
        height = canvas.clientHeight;
        canvas.width = width;
        canvas.height = height;
        drawGrid();
    }
    window.addEventListener('load', () => {
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
    });

    function drawGrid() {
        ctx.clearRect(0, 0, width, height);
        ctx.strokeStyle = '#333'; ctx.lineWidth = 0.5;
        for (let x = 0; x < width; x += 10) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,height); ctx.stroke(); }
        for (let y = 0; y < height; y += 10) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(width,y); ctx.stroke(); }
        ctx.strokeStyle = '#444'; ctx.lineWidth = 1;
        for (let x = 0; x < width; x += 50) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,height); ctx.stroke(); }
        for (let y = 0; y < height; y += 50) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(width,y); ctx.stroke(); }
    }

    // Simple Rhythms (for testing)
    const rhythms = {
        nsr: [{name: 'NSR 70bpm', rate: 70, pr: 40, qrs: 20}],
        sinusTach: [{name: 'Sinus Tach 120bpm', rate: 120, pr: 30, qrs: 20}],
        vFib: [{name: 'Coarse VFib', freq: 300, amp: 30}],
        asystole: [{name: 'Asystole Flat', noise: 0}]
    };

    function makeRhythm(param, type) {
        return function(x) {
            let y = height / 2;
            const rate = param.rate || 60;
            const beat = width * 60 / rate / 10;
            const t = x % beat;

            if (type === 'vFib') {
                y += (Math.random() - 0.5) * param.amp * Math.sin(x * 0.1);
            } else if (type === 'asystole') {
                y += (Math.random() - 0.5) * param.noise;
            } else {
                const prT = t - param.pr;
                y += Math.sin(t * 0.3) * 10; // P
                if (prT > 0) y += (prT < param.qrs ? -40 : 0); // QRS
                if (prT > param.qrs) y += Math.sin((prT - param.qrs) * 0.2) * 15; // T
            }
            return y;
        };
    }

    // Animation
    function animate() {
        ctx.drawImage(canvas, -speed, 0);
        ctx.clearRect(width - speed, 0, speed, height);
        for (let i = 0; i < speed; i++) {
            const x = width - speed + i;
            const y = currentRhythm ? currentRhythm((offset + x) % width) : height / 2;
            ctx.strokeStyle = lineColor;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x, y);
            ctx.stroke();
        }
        offset = (offset + speed) % width;
        requestAnimationFrame(animate);
    }
    animate();

    // Quiz
    let selectedCategory = 'all';
    let totalQuestions = 15;
    let currentQ = 0;
    let score = 0;
    let selectedAnswer = -1;
    let quizRhythms = [];
    let correctIndex = 0;

    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedCategory = btn.dataset.type;
        });
    });

    document.getElementById('start-btn').addEventListener('click', () => {
        totalQuestions = parseInt(document.getElementById('question-count').value);
        const pool = selectedCategory === 'all' ? Object.values(rhythms).flat() : rhythms[selectedCategory] || [];
        quizRhythms = [];
        for (let i = 0; i < totalQuestions; i++) {
            const r = pool[Math.floor(Math.random() * pool.length)];
            quizRhythms.push({name: r.name, type: selectedCategory === 'all' ? getType(r.name) : selectedCategory, param: r});
        }
        currentQ = 0; score = 0;
        document.getElementById('quiz-container').classList.remove('hidden');
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('quiz-settings').style.display = 'none';
        loadQuestion();
    });

    function getType(name) {
        for (const [type, arr] of Object.entries(rhythms)) if (arr.some(r => r.name