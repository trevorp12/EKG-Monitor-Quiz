<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECG Rhythm Quiz</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e1e1e;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #header {
            width: 100%;
            max-width: 800px;
            margin-bottom: 20px;
            text-align: center;
        }
        #category-bar {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .category-btn {
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .category-btn:hover, .category-btn.active {
            background-color: #00bfff;
            color: #1a1a1a;
            border-color: #00bfff;
        }
        #quiz-settings {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        #quiz-settings select, #start-btn {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #555;
            background-color: #2c2c2c;
            color: #e0e0e0;
            font-size: 14px;
        }
        #start-btn {
            background-color: #00ff7f;
            color: #1a1a1a;
            font-weight: bold;
            cursor: pointer;
        }
        #start-btn:hover {
            background-color: #00cc66;
        }
        #monitor {
            width: 100%;
            max-width: 800px;
            height: 200px;
            background-color: #2c2c2c;
            border: 2px solid #4a4a4a;
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        #quiz-container {
            max-width: 600px;
            text-align: center;
            background-color: #2c2c2c;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
        }
        #question {
            font-size: 20px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        #options {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #options li {
            margin: 10px 0;
            padding: 12px;
            background-color: #3a3a3a;
            border: 1px solid #5a5a5a;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }
        #options li:hover {
            background-color: #4a4a4a;
        }
        #options li.selected {
            background-color: #00ff7f;
            color: #1a1a1a;
            font-weight: bold;
        }
        #feedback {
            margin-top: 20px;
            font-size: 16px;
            min-height: 50px;
            padding: 10px;
            background-color: #333;
            border-radius: 6px;
        }
        #score {
            display: none;
            font-size: 28px;
            margin: 20px 0;
            font-weight: bold;
        }
        button {
            background-color: #00ff7f;
            color: #1a1a1a;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
            border-radius: 6px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #00cc66;
        }
        .hidden { display: none; }
    </style>
</head>
<body>

<div id="header">
    <h1>ECG Rhythm Quiz</h1>
    <div id="category-bar">
        <button class="category-btn active" data-type="all">All Rhythms</button>
        <button class="category-btn" data-type="nsr">Normal Sinus</button>
        <button class="category-btn" data-type="sinusTach">Sinus Tach</button>
        <button class="category-btn" data-type="sinusBrad">Sinus Brad</button>
        <button class="category-btn" data-type="vFib">V-Fib</button>
        <button class="category-btn" data-type="vTach">V-Tach</button>
        <button class="category-btn" data-type="firstDegreeBlock">1° Block</button>
        <button class="category-btn" data-type="mobitz1">Mobitz I</button>
        <button class="category-btn" data-type="mobitz2">Mobitz II</button>
        <button class="category-btn" data-type="thirdDegreeBlock">3° Block</button>
        <button class="category-btn" data-type="pac">PAC</button>
        <button class="category-btn" data-type="pvc">PVC</button>
        <button class="category-btn" data-type="pjc">PJC</button>
        <button class="category-btn" data-type="pea">PEA</button>
        <button class="category-btn" data-type="asystole">Asystole</button>
    </div>
    <div id="quiz-settings">
        <select id="question-count">
            <option value="10">10 Questions</option>
            <option value="15" selected>15 Questions</option>
            <option value="20">20 Questions</option>
            <option value="25">25 Questions</option>
        </select>
        <button id="start-btn">Start Quiz</button>
    </div>
</div>

<div id="monitor">
    <canvas id="ecg-canvas"></canvas>
</div>

<div id="quiz-container" class="hidden">
    <div id="question"></div>
    <ul id="options"></ul>
    <button id="submit-btn">Submit Answer</button>
    <button id="next-btn" class="hidden">Next Question</button>
    <div id="feedback"></div>
    <div id="score"></div>
</div>

<script>
    // Canvas Setup
    const canvas = document.getElementById('ecg-canvas');
    const ctx = canvas.getContext('2d');
    let width = canvas.width = 800;
    let height = canvas.height = 200;
    const pixelsPerSmall = 10;
    const pixelsPerLarge = 50;
    const speed = 2;
    const lineColor = '#00ff7f';
    let offset = 0;
    let currentRhythm = null;

    function resizeCanvas() {
        width = canvas.clientWidth;
        height = canvas.clientHeight;
        canvas.width = width;
        canvas.height = height;
        drawGrid();
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function drawGrid() {
        ctx.clearRect(0, 0, width, height);
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 0.5;
        for (let x = 0; x < width; x += pixelsPerSmall) {
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, height); ctx.stroke();
        }
        for (let y = 0; y < height; y += pixelsPerSmall) {
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(width, y); ctx.stroke();
        }
        ctx.strokeStyle = '#444';
        ctx.lineWidth = 1;
        for (let x = 0; x < width; x += pixelsPerLarge) {
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, height); ctx.stroke();
        }
        for (let y = 0; y < height; y += pixelsPerLarge) {
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(width, y); ctx.stroke();
        }
    }

    // Wave Components
    function pWave(t, amp = 10, dur = 20) {
        if (t < 0 || t > dur) return 0;
        return amp * Math.exp(-Math.pow(t - dur/2, 2) / (2 * Math.pow(dur/4, 2)));
    }
    function qrsComplex(t, amp = 40, dur = 20) {
        if (t < 0) return 0;
        if (t < dur/4) return -amp/2 * (t / (dur/4));
        if (t < dur/2) return amp * ((t - dur/4) / (dur/4));
        return -amp/2 * ((t - dur/2) / (dur/2));
    }
    function tWave(t, amp = 15, dur = 40) {
        if (t < 0 || t > dur) return 0;
        return amp * Math.sin(Math.PI * t / dur);
    }

    // Rhythm Database (5 variations each)
    const rhythms = {
        nsr: [
            {name: 'NSR 70bpm', rate: 70, pr: 40, qrs: 20, qt: 90, pAmp: 10, qrsAmp: 40, tAmp: 15},
            {name: 'NSR 80bpm', rate: 80, pr: 35, qrs: 18, qt: 85, pAmp: 9, qrsAmp: 38, tAmp: 14},
            {name: 'NSR 60bpm', rate: 60, pr: 45, qrs: 22, qt: 95, pAmp: 11, qrsAmp: 42, tAmp: 16},
            {name: 'NSR 90bpm', rate: 90, pr: 38, qrs: 19, qt: 88, pAmp: 10, qrsAmp: 40, tAmp: 15},
            {name: 'NSR 100bpm', rate: 100, pr: 30, qrs: 25, qt: 80, pAmp: 12, qrsAmp: 45, tAmp: 17}
        ],
        sinusTach: [
            {name: 'Sinus Tach 110bpm', rate: 110, pr: 30, qrs: 20, qt: 80},
            {name: 'Sinus Tach 120bpm', rate: 120, pr: 28, qrs: 18, qt: 75},
            {name: 'Sinus Tach 140bpm', rate: 140, pr: 25, qrs: 22, qt: 70},
            {name: 'Sinus Tach 160bpm', rate: 160, pr: 22, qrs: 19, qt: 65},
            {name: 'Sinus Tach 180bpm', rate: 180, pr: 20, qrs: 25, qt: 60}
        ],
        sinusBrad: [
            {name: 'Sinus Brad 50bpm', rate: 50, pr: 50, qrs: 20, qt: 100},
            {name: 'Sinus Brad 45bpm', rate: 45, pr: 55, qrs: 22, qt: 105},
            {name: 'Sinus Brad 55bpm', rate: 55, pr: 48, qrs: 18, qt: 95},
            {name: 'Sinus Brad 40bpm', rate: 40, pr: 60, qrs: 25, qt: 110},
            {name: 'Sinus Brad 58bpm', rate: 58, pr: 45, qrs: 19, qt: 98}
        ],
        vFib: [
            {name: 'Coarse VFib', freq: 300, amp: 30},
            {name: 'Fine VFib', freq: 400, amp: 15},
            {name: 'Medium VFib', freq: 350, amp: 25},
            {name: 'High Freq VFib', freq: 450, amp: 20},
            {name: 'Low Freq VFib', freq: 250, amp: 35}
        ],
        vTach: [
            {name: 'VTach 150bpm', rate: 150, qrs: 35, amp: 50},
            {name: 'VTach 180bpm', rate: 180, qrs: 40, amp: 55},
            {name: 'VTach 120bpm', rate: 120, qrs: 32, amp: 48},
            {name: 'VTach 200bpm', rate: 200, qrs: 38, amp: 52},
            {name: 'VTach 220bpm', rate: 220, qrs: 42, amp: 60}
        ],
        firstDegreeBlock: [
            {name: '1° Block 70bpm', rate: 70, pr: 60, qrs: 20, qt: 90},
            {name: '1° Block 80bpm', rate: 80, pr: 65, qrs: 18, qt: 85},
            {name: '1° Block 60bpm', rate: 60, pr: 70, qrs: 22, qt: 95},
            {name: '1° Block 90bpm', rate: 90, pr: 58, qrs: 19, qt: 88},
            {name: '1° Block 100bpm', rate: 100, pr: 75, qrs: 25, qt: 80}
        ],
        mobitz1: [
            {name: 'Mobitz I 4:3', rate: 80, ratio: 4},
            {name: 'Mobitz I 3:2', rate: 70, ratio: 3},
            {name: 'Mobitz I 5:4', rate: 90, ratio: 5},
            {name: 'Mobitz I 6:5', rate: 60, ratio: 6},
            {name: 'Mobitz I 2:1', rate: 100, ratio: 2}
        ],
        mobitz2: [
            {name: 'Mobitz II 2:1', rate: 80, ratio: 2},
            {name: 'Mobitz II 3:2', rate: 70, ratio: 3},
            {name: 'Mobitz II 4:3', rate: 90, ratio: 4},
            {name: 'Mobitz II 5:4', rate: 60, ratio: 5},
            {name: 'Mobitz II 6:5', rate: 100, ratio: 6}
        ],
        thirdDegreeBlock: [
            {name: '3° Block V40', aRate: 80, vRate: 40, qrs: 35},
            {name: '3° Block V35', aRate: 90, vRate: 35, qrs: 38},
            {name: '3° Block V45', aRate: 70, vRate: 45, qrs: 32},
            {name: '3° Block V30', aRate: 100, vRate: 30, qrs: 40},
            {name: '3° Block V50', aRate: 60, vRate: 50, qrs: 35}
        ],
        pac: [
            {name: 'PAC every 5', base: 80, freq: 5},
            {name: 'PAC every 4', base: 70, freq: 4},
            {name: 'PAC every 6', base: 90, freq: 6},
            {name: 'PAC every 3', base: 60, freq: 3},
            {name: 'PAC every 7', base: 100, freq: 7}
        ],
        pvc: [
            {name: 'PVC every 5', base: 80, freq: 5, qrs: 35},
            {name: 'PVC every 4', base: 70, freq: 4, qrs: 38},
            {name: 'PVC every 6', base: 90, freq: 6, qrs: 32},
            {name: 'PVC every 3', base: 60, freq: 3, qrs: 40},
            {name: 'PVC every 7', base: 100, freq: 7, qrs: 35}
        ],
        pjc: [
            {name: 'PJC every 5', base: 80, freq: 5},
            {name: 'PJC every 4', base: 70, freq: 4},
            {name: 'PJC every 6', base: 90, freq: 6},
            {name: 'PJC every 3', base: 60, freq: 3},
            {name: 'PJC every 7', base: 100, freq: 7}
        ],
        pea: [
            {name: 'PEA 40bpm Wide', rate: 40, qrs: 35, amp: 40},
            {name: 'PEA 35bpm', rate: 35, qrs: 38, amp: 38},
            {name: 'PEA 45bpm', rate: 45, qrs: 32, amp: 42},
            {name: 'PEA 30bpm', rate: 30, qrs: 40, amp: 45},
            {name: 'PEA 50bpm', rate: 50, qrs: 35, amp: 40}
        ],
        asystole: [
            {name: 'Asystole Flat', noise: 0},
            {name: 'Asystole Noise 1', noise: 2},
            {name: 'Asystole Noise 2', noise: 1},
            {name: 'Asystole Noise 3', noise: 3},
            {name: 'Asystole Noise 4', noise: 1.5}
        ]
    };

    // Generate Rhythm Function
    function makeRhythm(param, type) {
        return function(x) {
            let y = height / 2;
            const beat = width * 60 / (param.rate || param.base || param.vRate || 60) / pixelsPerSmall;
            const t = x % beat;
            if (type === 'vFib') {
                y += (Math.random() - 0.5) * param.amp * Math.sin(x * 0.1);
            } else if (type === 'asystole') {
                y += (Math.random() - 0.5) * param.noise;
            } else if (type === 'thirdDegreeBlock') {
                const aT = x % (width * 60 / param.aRate / pixelsPerSmall);
                const vT = x % (width * 60 / param.vRate / pixelsPerSmall);
                y += pWave(aT, 10, 20);
                y += qrsComplex(vT, 40, param.qrs);
            } else if (type === 'mobitz1') {
                const cycle = Math.floor(x / beat) % param.ratio;
                if (cycle === param.ratio - 1) return y;
                const pr = 40 + cycle * 5;
                const qt = t - pr;
                y += pWave(t, 10, 20);
                if (qt > 0) y += qrsComplex(qt, 40, 20);
            } else if (type === 'mobitz2') {
                const cycle = Math.floor(x / beat) % param.ratio;
                y += pWave(t, 10, 20);
                if (cycle !== param.ratio - 1) {
                    const qt = t - 40;
                    if (qt > 0) y += qrsComplex(qt, 40, 20);
                }
            } else if (['pac', 'pvc', 'pjc'].includes(type)) {
                const isPrem = Math.floor(x / beat) % param.freq === 0;
                const localT = isPrem ? t * 0.7 : t;
                y += pWave(localT, 10, 20);
                const qrsW = type === 'pvc' ? param.qrs : 20;
                y += qrsComplex(localT, 40, qrsW);
            } else {
                const prT = t - param.pr;
                y += pWave(t, param.pAmp || 10, 20);
                if (prT > 0) y += qrsComplex(prT, param.qrsAmp || 40, param.qrs || 20);
                if (prT > (param.qrs || 20)) y += tWave(prT - (param.qrs || 20), param.tAmp || 15, 40);
            }
            return y;
        };
    }

    // Animation
    function animate() {
        ctx.drawImage(canvas, -speed, 0);
        ctx.clearRect(width - speed, 0, speed, height);
        for (let i = 0; i < speed; i++) {
            const x = width - speed + i;
            const y = currentRhythm ? currentRhythm(offset + x) : height / 2;
            ctx.strokeStyle = lineColor;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x, y);
            ctx.stroke();
        }
        offset += speed;
        requestAnimationFrame(animate);
    }
    animate();

    // Quiz State
    let selectedCategory = 'all';
    let totalQuestions = 15;
    let currentQ = 0;
    let score = 0;
    let selectedAnswer = -1;
    let quizRhythms = [];
    let correctIndex = 0;

    // Category Buttons
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedCategory = btn.dataset.type;
        });
    });

    // Start Quiz
    document.getElementById('start-btn').addEventListener('click', () => {
        totalQuestions = parseInt(document.getElementById('question-count').value);
        const pool = selectedCategory === 'all' 
            ? Object.values(rhythms).flat() 
            : rhythms[selectedCategory] || [];
        quizRhythms = [];
        for (let i = 0; i < totalQuestions; i++) {
            const r = pool[Math.floor(Math.random() * pool.length)];
            quizRhythms.push({...r, type: selectedCategory === 'all' ? getTypeFromName(r.name) : selectedCategory});
        }
        currentQ = 0;
        score = 0;
        document.getElementById('quiz-container').classList.remove('hidden');
        document.getElementById('start-btn').style.display = 'none';
        document.getElementById('quiz-settings').style.display = 'none';
        loadQuestion();
    });

    function getTypeFromName(name) {
        for (const [type, arr] of Object.entries(rhythms)) {
            if (arr.some(r => r.name === name)) return type;
        }
        return 'nsr';
    }

    function loadQuestion() {
        const r = quizRhythms[currentQ];
        currentRhythm = makeRhythm(r, r.type);
        document.getElementById('question').textContent = `Question ${currentQ + 1} of ${totalQuestions}: Identify this rhythm.`;
        const options = [r.name];
        const distractors = getDistractors(r.type, r.name);
        options.push(...distractors);
        options.sort(() => Math.random() - 0.5);
        correctIndex = options.indexOf(r.name);

        const ul = document.getElementById('options');
        ul.innerHTML = '';
        options.forEach((opt, i) => {
            const li = document.createElement('li');
            li.textContent = opt;
            li.onclick = () => selectAnswer(i);
            ul.appendChild(li);
        });

        document.getElementById('feedback').innerHTML = '';
        document.getElementById('submit-btn').classList.remove('hidden');
        document.getElementById('next-btn').classList.add('hidden');
        selectedAnswer = -1;
    }

    function getDistractors(type, correctName) {
        const all = Object.values(rhythms).flat();
        const pool = all.filter(r => r.name !== correctName);
        const shuffled = pool.sort(() => Math.random() - 0.5);
        return shuffled.slice(0, 3).map(r => r.name);
    }

    function selectAnswer(i) {
        document.querySelectorAll('#options li').forEach((li, j) => li.classList.toggle('selected', j === i));
        selectedAnswer = i;
    }

    document.getElementById('submit-btn').addEventListener('click', () => {
        if (selectedAnswer === -1) return alert('Please select an answer!');
        const fb = document.getElementById('feedback');
        if (selectedAnswer === correctIndex) {
            score++;
            fb.innerHTML = `<span style="color:#00ff7f;">Correct!</span>`;
        } else {
            const correctName = document.querySelectorAll('#options li')[correctIndex].textContent;
            fb.innerHTML = `<span style="color:#ff4d4d;">Incorrect.</span> Correct: ${correctName}`;
        }
        document.getElementById('submit-btn').classList.add('hidden');
        document.getElementById('next-btn').classList.remove('hidden');
    });

    document.getElementById('next-btn').addEventListener('click', () => {
        currentQ++;
        if (currentQ < totalQuestions) {
            loadQuestion();
        } else {
            document.getElementById('quiz-container').innerHTML = `
                <h1>Quiz Complete!</h1>
                <div id="score">Final Score: ${score} / ${totalQuestions} (${Math.round(score/totalQuestions*100)}%)</div>
                <button onclick="location.reload()">Start New Quiz</button>
            `;
        }
    });
</script>
</body>
</html>